# GitHub Integration (Phase 0)

## Overview
The GitHub Integration layer enables the IDSE Agency to automatically commit generated artifacts (specs, plans, tasks) to your repository and trigger CI/CD validation workflows.

## Architecture

```
┌──────────────────────────────────┐
│ IDSE Agency (idse_developer_agent│
│ ──────────────────────────────── │
│                                  │
│ Agent generates artifacts        │
│ ├─ spec.md                       │
│ ├─ plan.md                       │
│ └─ tasks.md                      │
│                                  │
│ Agent calls CommitArtifactsTool  │
└────────────┬─────────────────────┘
             │
             │ HTTP POST /api/git/commit
             ▼
┌──────────────────────────────────┐
│ FastAPI Backend (backend/main.py)│
│ ──────────────────────────────── │
│                                  │
│ git_routes.py → git_service.py   │
│ ↓                                │
│ PyGithub → GitHub API            │
└────────────┬─────────────────────┘
             │
             │ Git commit + push
             │ repository_dispatch webhook
             ▼
┌──────────────────────────────────┐
│ GitHub Repository                │
│ ──────────────────────────────── │
│                                  │
│ Artifacts committed to branch    │
│                                  │
│ GitHub Action triggered:         │
│ ├─ Validate artifacts            │
│ ├─ Run compliance checks         │
│ └─ Report status back to Agency  │
└──────────────────────────────────┘
```

## Setup

### 1. Create GitHub Personal Access Token

1. Go to https://github.com/settings/tokens
2. Click "Generate new token" → "Generate new token (classic)"
3. Select scopes:
   - ✅ `repo` (Full control of private repositories)
   - ✅ `workflow` (Update GitHub Action workflows)
4. Generate and copy the token

### 2. Configure Environment Variables

Edit `.env`:

```bash
# GitHub Integration
GITHUB_AUTH_MODE=pat
GITHUB_PAT=ghp_your_token_here  # Replace with your token
GITHUB_OWNER=tjpilant           # Your GitHub username
GITHUB_REPO=idse-developer-agency  # Your repository name

# Agency API URL (for tools)
AGENCY_API_URL=http://localhost:8000
```

### 3. Verify Installation

```bash
# Activate virtual environment
source .venv/bin/activate

# Verify PyGithub installed
python -c "import github; print('PyGithub installed:', github.__version__)"

# Start backend
python backend/main.py
```

### 4. Test Authentication

```bash
curl http://localhost:8000/api/git/status
```

Expected response:
```json
{
  "success": true,
  "repo": "tjpilant/idse-developer-agency",
  "default_branch": "main",
  "has_write_access": true,
  "authenticated_user": "tjpilant"
}
```

## Usage

### From Agency Agents

Agents use `CommitArtifactsTool` to commit their generated artifacts:

```python
from idse_developer_agent.tools import CommitArtifactsTool

tool = CommitArtifactsTool(
    session_id="Puck_Components",
    project="IDSE_Core",
    file_paths=[
        "specs/projects/IDSE_Core/sessions/Puck_Components/spec.md",
        "plans/projects/IDSE_Core/sessions/Puck_Components/plan.md"
    ],
    commit_message="feat(idse): add Puck Components spec and plan",  # Optional
    branch="main",  # Optional, defaults to default branch
    trigger_dispatch=True  # Triggers CI validation
)

result = tool.run()
print(result)  # ✅ Successfully committed 2 file(s) to main...
```

### Via HTTP API

```bash
# Commit artifacts
curl -X POST http://localhost:8000/api/git/commit \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": "Puck_Components",
    "project": "IDSE_Core",
    "files": [
      {
        "path": "specs/projects/IDSE_Core/sessions/Puck_Components/spec.md",
        "content": "# Specification\n\n..."
      }
    ],
    "trigger_dispatch": true
  }'
```

### Create Pull Request

```bash
curl -X POST http://localhost:8000/api/git/pr \
  -H "Content-Type: application/json" \
  -d '{
    "head_branch": "feature/new-spec",
    "base_branch": "main",
    "title": "feat(idse): Add new specification",
    "body": "Generated by IDSE Agency\n\nSession: session-123"
  }'
```

## API Endpoints

### POST `/api/git/commit`
Commit artifacts to repository

**Request Body:**
```json
{
  "session_id": "string",
  "project": "string",
  "files": [
    {"path": "string", "content": "string"}
  ],
  "message": "string (optional)",
  "branch": "string (optional)",
  "trigger_dispatch": "boolean (default: true)"
}
```

**Response:**
```json
{
  "success": true,
  "commit_sha": "abc1234",
  "commit_url": "https://github.com/...",
  "files_committed": 2,
  "branch": "main",
  "session_id": "Puck_Components",
  "project": "IDSE_Core",
  "dispatch": {
    "success": true,
    "event_type": "agency-update",
    "payload": {
      "session_id": "Puck_Components",
      "project": "IDSE_Core",
      "commit_sha": "abc1234"
    }
  }
}
```

### POST `/api/git/pr`
Create pull request

### GET `/api/git/status`
Check repository status and authentication

### POST `/api/git/dispatch`
Manually trigger repository_dispatch event

### POST `/api/git/branch`
Create a new branch

## repository_dispatch Event

When `trigger_dispatch=true`, the following webhook is sent to GitHub:

**Event Type:** `agency-update`

**Payload:**
```json
{
  "session_id": "Puck_Components",
  "project": "IDSE_Core",
  "commit_sha": "abc1234567"
}
```

### GitHub Action Integration

Create `.github/workflows/agency-sync.yml`:

```yaml
name: Agency Artifact Sync

on:
  repository_dispatch:
    types: [agency-update]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate artifacts
        run: |
          echo "Session: ${{ github.event.client_payload.session_id }}"
          echo "Project: ${{ github.event.client_payload.project }}"
          python idse-governance/validate-artifacts.py --session-aware

      - name: Report status to Agency
        if: always()
        run: |
          curl -X POST ${{ secrets.AGENCY_WEBHOOK_URL }}/api/ci/status \
            -d '{"session_id": "${{ github.event.client_payload.session_id }}", "status": "${{ job.status }}"}'
```

## Troubleshooting

### Authentication Errors
```
ValueError: GITHUB_PAT environment variable not set
```
**Solution:** Set `GITHUB_PAT` in `.env` file

### Permission Errors
```
GithubException: 403 Resource not accessible by integration
```
**Solution:** Ensure PAT has `repo` and `workflow` scopes

### Connection Errors
```
❌ Cannot connect to Agency backend API
```
**Solution:** Start backend with `python backend/main.py`

## Security Best Practices

1. **Never commit `.env` file** - It contains sensitive tokens
2. **Use `.env.example`** for documentation
3. **Rotate tokens regularly** - Generate new PAT every 90 days
4. **Use GitHub App** (future) - More secure than PATs for production
5. **Limit token scope** - Only grant necessary permissions

## Next Steps

- [ ] Wire CommitArtifactsTool into post-generation workflows
- [ ] Add pre-commit validation hooks
- [ ] Implement GitHub App authentication (more secure)
- [ ] Add conflict detection before commits
- [ ] Implement feedback loop (CI → Agency webhook)

## Files Created

Phase 0 implementation includes:

- `backend/services/git_service.py` - Core GitHub API wrapper
- `backend/routes/git_routes.py` - FastAPI endpoints
- `idse_developer_agent/tools/CommitArtifactsTool.py` - Agency Swarm tool
- `.env.example` - Environment configuration template
- `docs/github-integration.md` - This documentation
